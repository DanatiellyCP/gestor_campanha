{% load static %}
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Promoção Bombril - Home</title>
    <meta name="description"
        content="Participe da promoção Bombril e concorra a prêmios incríveis. Cadastre seus cupons e dê um brilho no seu futuro!">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://kit.fontawesome.com/f0d3945d17.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.typekit.net/nnt2jwc.css">

    <link rel="icon" type="image/png" href="{% static 'responsive/images/Favicon.png' %}">
    <link rel="stylesheet" href="{% static 'responsive/menu.css' %}?v=2025-08-13-1">
</head>
<body>
  <div class="wrap">
    <header class="menu" role="navigation" aria-label="Principal">
      <div class="bar">
        <a class="brand" href="#" aria-label="Página inicial">
          <img src="{% static 'responsive/images/LOGO_BOMBRIL.png' %}" alt="Bombril" />
        </a>
        <nav aria-label="Seções">
          <ul class="links">
            <li><a href="/painel-home/">Inicio</a></li>
            <li><a target="_blank" href="/lista-resultados/">Sorteios</a></li>
            <li><a href="/painel-cadastrar-cupom/">Cadastrar cupons</a></li>
            <li><a href="/painel-home/">Editar perfil</a></li>
          </ul>
        </nav>
        <div class="actions">
          <a href="{% url 'logout' %}" class="btn btn-participe" id="ctaParticipar">SAIR</a>
        </div>
        <button class="hamb" id="hamb" aria-label="Abrir menu" aria-expanded="false" aria-controls="drawer">
          <span></span><span></span><span></span>
        </button>
      </div>
      <div class="drawer" id="drawer">
        <ul class="links">
          <br/>
          <li><a href="/painel-home/">Inicio</a></li>
          <li><a target="_blank" href="/lista-resultados/">Sorteios</a></li>
          <li><a href="/painel-cadastrar-cupom/">Cadastrar cupons</a></li>
          <li><a href="/painel-home/">Editar perfil</a></li>
        </ul>
        <div class="actions">
          <a href="{% url 'logout' %}" class="btn btn-participe" id="mParticipar">SAIR</a>
        </div>
      </div>
    </header>
  </div>

  <div class="topo panel-hero" role="img" aria-label="Topo do site">
    <img src="{% static 'responsive/images/background_topo.png' %}" alt="" class="topo-measure" aria-hidden="true" />
    <div class="inner">
      <h1 class="sr-only">Painel</h1>
      <div class="panel-duo" aria-hidden="true">
        <img src="{% static 'responsive/images/PRODUTOS.png' %}" alt="" class="panel-logo" />
        <img src="{% static 'responsive/images/painel_promocao.png' %}" alt="" class="panel-side" />
      </div>
      <img src="{% static 'responsive/images/ROBOM-BRIL_NAVE.png' %}" alt="" class="topo-robot" aria-hidden="true" />
    </div>
  </div>
  <div id="content">
    <section class="coupon-register" aria-label="Cadastro de cupom">
      <div class="inner">
        <header class="panel-header">
          <h2 class="panel-title">Cadastro de cupom</h2>
          <p>Confira como escanear seu cupom<a target="_blank" style="margin-left: 5px;" href="/tutorial/">aqui</a></p>
          <p class="panel-sub">Escolha a forma de cadastro</p>
        </header>
        
        {% if msg_erro %}
        <div id="alertErroCupom" role="alert" class="alert alert-error alert-error--strong" tabindex="-1" aria-live="assertive">
          <span class="alert-ico" aria-hidden="true">⚠️</span>
          {% with msg_lower=msg_erro|lower %}
          {% if msg_lower|slice:":14" == 'chave inválida' %}
          <strong>Não foi possivel processar seu cupom agora.</strong>
          {% else %}
          <strong>{{ msg_erro|capfirst }}</strong>
          {% endif %}
          {% endwith %}
          {% if msg_erro|lower != 'cupom já cadastrado' %}
          <span class="alert-msg"> Tente ler o QR Code ou digite o código. Se persistir, aguarde alguns instantes e tente novamente. </span>
          {% endif %}
        </div>
        {% endif %}
        {% if msg_sucesso %}
        <div role="status" class="alert alert-success">{{ msg_sucesso }}</div>
        {% endif %}
        {% if msg_numeros %}
        <div role="status" class="alert alert-info">{{ msg_numeros }}</div>
        {% endif %}
        <section class="register-block" aria-label="01 - Envie a imagem do seu cupom">
          <h3 class="register-step"><span class="num">01</span> - Envie a imagem do seu cupom</h3>
          <form class="register-form" action="{% url 'cadastrar_cupom' id_participante %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label class="file-field">
              <input id="inputImgCupom" type="file" name="img_cupom" accept="image/*" required aria-label="Carregar imagem do cupom" />
              <span id="filePlaceholder" class="placeholder" aria-live="polite">Carregar arquivo</span>
            </label>
            <div class="actions">
              <button type="submit" name="submit_imagem" value="1" class="btn-red">ENVIAR IMAGEM</button>
            </div>
          </form>
        </section>

        <hr class="register-sep" aria-hidden="true" />

        <section class="register-block" aria-label="02 - Escaneie o QR Code do cupom com a sua câmera">
          <h3 class="register-step"><span class="num">02</span> - Ou escaneie o QR Code do cupom com a sua câmera</h3>
          <div class="register-row">
            <button type="button" id="btnAtivarCamera" class="btn-red btn-red--sm" aria-controls="qrVideo" aria-expanded="false">ATIVAR CÂMERA</button>
            <label class="camera-picker" id="cameraPickerWrap" aria-live="polite" aria-atomic="true">
              <span class="camera-picker__label">Câmera:</span>
              <select id="cameraSelect" aria-label="Selecione a câmera" class="camera-picker__select"></select>
            </label>
            <a href="#" class="hint-link">Onde encontrar?</a>
          </div>
          <div class="qr-preview" aria-live="polite" aria-busy="false">
            <video id="qrVideo" playsinline style="width: 100%; max-width: 420px; display: none; border-radius: 8px;" aria-label="Pré-visualização da câmera para leitura do QR Code"></video>
            <canvas id="qrCanvas" style="display:none"></canvas>
            <p id="qrStatus" class="hint" style="margin-top:8px; display:none;">Aponte a câmera para o QR Code do seu cupom…</p>
          </div>
          <img src="{% static 'responsive/images/seta_cupom_qr.png' %}" alt="Seta apontando para o QR Code no cupom" class="reg-arrow reg-arrow--qr" aria-hidden="true" />
          <img src="{% static 'responsive/images/cupom_qr.png' %}" alt="Exemplo de cupom destacando o QR Code" class="reg-art reg-art--qr" aria-hidden="true" />
        </section>

        <hr class="register-sep" aria-hidden="true" />

        <section class="register-block" aria-label="03 - Digite o código do seu cupom">
          <h3 class="register-step"><span class="num">03</span> - Ou digite o código do seu cupom</h3>
          <form id="formCodigo" class="register-form" action="{% url 'cadastrar_cupom' id_participante %}" method="post">
            {% csrf_token %}
            <label class="text-field">
              <input id="inputCodigo" type="text" name="cod_cupom" placeholder="" aria-label="Código do cupom" />
            </label>
            <div class="actions">
              <button type="submit" name="submit_codigo" value="1" class="btn-red btn-red--sm">ENVIAR CÓDIGO</button>
              <a href="#" class="hint-link">Onde encontrar?</a>
            </div>
          </form>
          <img src="{% static 'responsive/images/seta_cupom_code.png' %}" alt="Seta apontando para a chave de acesso no cupom" class="reg-arrow reg-arrow--code" aria-hidden="true" />
          <img src="{% static 'responsive/images/cupom_code.png' %}" alt="Exemplo de cupom destacando a chave de acesso" class="reg-art reg-art--code" aria-hidden="true" />
        </section>
      </div>
    </section>
  </div>
  <footer class="footer">
    <div class="inner">
      <div class="footer-top">
        <h2 class="footer-title">É MAIS QUE BOM. É DA</h2>
        <img class="footer-logo" src="{% static 'responsive/images/LOGO_BOMBRIL.png' %}" alt="Bombril" />
      </div>
      <ul class="footer-links">
        <li><a target="_blank" href="https://ri.bombril.com.br/termos-e-condicoes-de-uso">Termos de uso</a></li>
        <li><a target="_blank" href="https://www.bombril.com.br/politica-de-privacidade">Política de privacidade</a></li>
        <li><a target="_blank" href="https://www.bombril.com.br/politica-de-privacidade">LGPD</a></li>
      </ul>
      <p class="footer-legal">
        PARTICIPAÇÃO: DE 15/08/2025 ÀS 23H59 DE 15/10/2025. SORTEIOS: 20/08/2025, 23/08/2025, 27/08/2025, 30/08/2025, 03/09/2025, 06/09/2025, 10/09/2025, 13/09/2025, 17/09/2025, 20/09/2025, 24/09/2025, 27/09/2025, 01/10/2025, 04/10/2025, 08/10/2025, 11/10/2025, 15/10/2025 e 18/10/2025 PELO RESULTADO DA LOTERIA FEDERAL. PROMOÇÃO VÁLIDA PARA MAIORES DE 18 ANOS. LIMITE DE 3 NÚMEROS DA SORTE POR CUPOM FISCAL CADASTRADO. CONSULTE REGULAMENTO COM Nº DO CERTIFICADO DE AUTORIZAÇÃO SPA/MF EM WWW.PROMOCAOBOMBRIL.COM.BR. *SUGESTÃO DE PRÊMIO. A PREMIAÇÃO SERÁ ENTREGUE EM CARTEIRA DIGITAL, SEM FUNÇÃO SAQUE E TRANSFERÊNCIA, CONFORME REGULAMENTO.
      </p>
      <p class="footer-legal">
        Em caso de dúvidas, entre em contato com nosso SAC:<br/>

        E-mail: faleconosco@promocaobombril.com.br<br/>

        Telefone: 0800 7076161
      </p>
    </div>
  </footer>

  <!-- Privacy/Cookie banner -->
  <div class="cookie-banner" id="cookieBanner" role="region" aria-label="Aviso de cookies e privacidade">
    <div class="cookie-inner">
      <p class="cookie-text">Utilizamos cookies para otimizar sua experiência em nosso site. Ao continuar a navegação, você concorda com a nossa <a href="/privacidade" target="_blank" rel="noopener">Política de Privacidade</a>.</p>
      <button class="cookie-accept" id="cookieAccept">ACEITAR E FECHAR</button>
    </div>
   </div>
  <script src="{% static 'responsive/menu.js' %}?v=2025-08-13-1"></script>
  <!-- jsQR para decodificar QR Codes no cliente -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- Overlay de carregamento -->
  <style>
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .loading-box { background: #fff; padding: 16px 20px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,.25); font: 600 16px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; display: flex; gap: 10px; align-items: center; }
    .spinner { width: 20px; height: 20px; border: 3px solid #dcdcdc; border-top-color: #e30613; border-radius: 50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Camera picker styles */
    .camera-picker{ margin-left:10px; display:none; align-items:center; gap:8px; background:#fff; border:1px solid #e3e3e3; border-radius:10px; padding:6px 10px; }
    .camera-picker__label{ font-size:.9rem; color:#555; font-weight:700; }
    .camera-picker__select{ appearance:none; -webkit-appearance:none; -moz-appearance:none; padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fafafa; font-weight:700; color:#333; }
    .camera-picker__select:focus{ outline:2px solid var(--focus); outline-offset:2px; }
    /* Upload field visuals */
    .file-field{ display:inline-flex; align-items:center; gap:10px; border:1px dashed #cfcfcf; padding:10px 12px; border-radius:8px; cursor:pointer; background:#fff; }
    .file-field input[type=file]{ display:none; }
    .file-field .placeholder{ color:#666; font-weight:700; }
    .file-field.selected{ border-color:#ff8d8d; background:#fff6f6; }
    .file-field.selected .placeholder{ color:#c01919; }
    .file-field.selected .placeholder::before{ content:"✔ "; color:#c01919; font-weight:900; }
    /* Error alert emphasis */
    .alert{ padding: 14px 16px; border-radius: 8px; margin: 12px 0; font-size: 16px; line-height: 1.4; }
    .alert-error{ background: #fff5f5; color: #8a1f1f; border: 1px solid #f3c2c2; }
    .alert-success{ background: #f0fff4; color: #1f8a3a; border: 1px solid #b6e3c1; }
    .alert-info{ background: #f5fbff; color: #155a8a; border: 1px solid #b6d8f0; }
    .alert-error--strong{ box-shadow: 0 0 0 3px rgba(255, 0, 0, .12), 0 8px 20px rgba(0,0,0,.08); }
    .alert-ico{ margin-right: 8px; font-size: 18px; }
    .alert-help{ margin-top: 6px; color: #5c5c5c; font-size: 14px; }
  </style>
  <div id="loadingOverlay" class="loading-overlay" role="alert" aria-live="assertive" aria-busy="true">
    <div class="loading-box"><span class="spinner" aria-hidden="true"></span> Enviando seus dados…</div>
  </div>
  <script>
    (function() {
      const btn = document.getElementById('btnAtivarCamera');
      const video = document.getElementById('qrVideo');
      const canvas = document.getElementById('qrCanvas');
      const statusEl = document.getElementById('qrStatus');
      const form = document.getElementById('formCodigo');
      const input = document.getElementById('inputCodigo');
      const formImagem = document.querySelector('form.register-form[enctype="multipart/form-data"]');
      const inputImg = document.getElementById('inputImgCupom');
      const filePh = document.getElementById('filePlaceholder');
      const overlay = document.getElementById('loadingOverlay');
      const cameraSelect = document.getElementById('cameraSelect');
      const cameraPickerWrap = document.getElementById('cameraPickerWrap');

      if (!btn || !video || !canvas || !form || !input) return;

      let stream = null;
      let scanning = false;
      let devices = [];
      let currentDeviceId = null;

      function showOverlay(){ if (overlay) overlay.style.display = 'flex'; }
      function hideOverlay(){ if (overlay) overlay.style.display = 'none'; }

      function stopScanner() {
        scanning = false;
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
        video.style.display = 'none';
        statusEl.style.display = 'none';
        btn.setAttribute('aria-expanded', 'false');
      }

      function extractCodigoFromText(text) {
        if (!text) return null;
        // 1) tenta 44 dígitos
        const match44 = text.match(/\b\d{44}\b/);
        if (match44) return match44[0];
        // 2) trata formato CFe...|... (SAT)
        if (text.startsWith('CFe')) {
          const pos = text.indexOf('|');
          const head = pos > 0 ? text.substring(0, pos) : text;
          return head.replace(/CFe|\s+/g, '');
        }
        return null;
      }

      function friendlyCameraName(label, idx){
        const l = (label || '').toLowerCase();
        const isBack = l.includes('back') || l.includes('rear') || l.includes('trase') || l.includes('environment');
        const isFront = l.includes('front') || l.includes('face') || l.includes('frontal') || l.includes('user');
        let base = isBack ? 'Câmera traseira' : (isFront ? 'Câmera frontal' : `Câmera ${idx+1}`);
        if (l.includes('ultra') || l.includes('wide')) base += ' (ultra‑wide)';
        else if (l.includes('tele')) base += ' (teleobjetiva)';
        else if (l.includes('main') || l.includes('principal') || l.includes('wide angle')) base += ' (principal)';
        return base;
      }

      async function listVideoInputs() {
        try {
          const all = await navigator.mediaDevices.enumerateDevices();
          devices = all.filter(d => d.kind === 'videoinput');
          if (devices.length > 1) {
            cameraPickerWrap.style.display = 'inline-flex';
            // Preenche select se vazio ou mudou quantidade
            const prev = cameraSelect.value;
            cameraSelect.innerHTML = '';
            devices.forEach((d, idx) => {
              const opt = document.createElement('option');
              opt.value = d.deviceId;
              opt.textContent = friendlyCameraName(d.label, idx);
              cameraSelect.appendChild(opt);
            });
            // Mantém seleção anterior se existir
            const match = devices.find(d => d.deviceId === prev);
            cameraSelect.value = match ? prev : (devices[0]?.deviceId || '');
            currentDeviceId = cameraSelect.value;
          } else {
            cameraPickerWrap.style.display = 'none';
            currentDeviceId = devices[0]?.deviceId || null;
          }
        } catch (e) {
          // silencia enum errors
        }
      }

      async function startScanner(deviceId) {
        try {
          // Se deviceId informado, usa-o; senão tenta traseira
          const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } }
                                       : { video: { facingMode: 'environment' } };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          await video.play();
          video.style.display = 'block';
          statusEl.style.display = 'block';
          btn.setAttribute('aria-expanded', 'true');
          scanning = true;
          // Após ter permissão, podemos listar as câmeras com rótulos
          await listVideoInputs();
          if (!currentDeviceId && cameraSelect && cameraSelect.value) {
            currentDeviceId = cameraSelect.value;
          }
          requestAnimationFrame(tick);
        } catch (e) {
          console.error('Falha ao acessar a câmera', e);
          alert('Não foi possível acessar a câmera. Verifique as permissões do navegador.');
        }
      }

      function tick() {
        if (!scanning) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const w = video.videoWidth;
          const h = video.videoHeight;
          if (w && h) {
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, w, h);
            const imageData = ctx.getImageData(0, 0, w, h);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code && code.data) {
              const codigo = extractCodigoFromText(code.data);
              if (codigo && codigo.length === 44) {
                input.value = codigo;
                // garante submit_codigo=1
                let hidden = form.querySelector('input[name="submit_codigo"]');
                if (!hidden) {
                  hidden = document.createElement('input');
                  hidden.type = 'hidden';
                  hidden.name = 'submit_codigo';
                  hidden.value = '1';
                  form.appendChild(hidden);
                }
                stopScanner();
                showOverlay();
                form.submit();
                return;
              }
            }
          }
        }
        requestAnimationFrame(tick);
      }

      btn.addEventListener('click', function() {
        if (scanning) {
          stopScanner();
        } else {
          startScanner(currentDeviceId);
        }
      });

      if (cameraSelect) {
        cameraSelect.addEventListener('change', async function() {
          const newId = cameraSelect.value;
          if (!newId || newId === currentDeviceId) return;
          currentDeviceId = newId;
          const wasScanning = scanning;
          stopScanner();
          // reinicia com a nova câmera
          await startScanner(currentDeviceId);
        });
      }

      // Para segurança, para a câmera quando sair da página
      window.addEventListener('beforeunload', stopScanner);
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) stopScanner();
      });

      // Mostra overlay para qualquer envio manual
      if (form){
        form.addEventListener('submit', ()=> { showOverlay(); });
      }
      if (formImagem){
        formImagem.addEventListener('submit', ()=> { showOverlay(); });
      }

      // Feedback visual ao selecionar arquivo
      if (inputImg && filePh){
        inputImg.addEventListener('change', function(){
          const lbl = inputImg.closest('.file-field');
          if (!this.files || this.files.length === 0){
            filePh.textContent = 'Carregar arquivo';
            if (lbl) lbl.classList.remove('selected');
            return;
          }

          const file = this.files[0];
          const name = file.name;
          filePh.textContent = name;
          if (lbl) lbl.classList.add('selected');

          // Tenta decodificar QR localmente com jsQR para acelerar a experiência
          try {
            const reader = new FileReader();
            reader.onload = function(ev){
              try {
                const img = new Image();
                img.onload = function(){
                  try {
                    const off = document.createElement('canvas');
                    const MAX = 1080; // limita tamanho para performance
                    let w = img.naturalWidth || img.width;
                    let h = img.naturalHeight || img.height;
                    if (w > MAX || h > MAX){
                      const scale = Math.min(MAX / w, MAX / h);
                      w = Math.max(1, Math.round(w * scale));
                      h = Math.max(1, Math.round(h * scale));
                    }
                    off.width = w; off.height = h;
                    const ctx = off.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    const imageData = ctx.getImageData(0, 0, w, h);
                    const qr = jsQR(imageData.data, imageData.width, imageData.height);
                    if (qr && qr.data){
                      const codigo = extractCodigoFromText(qr.data);
                      if (codigo && codigo.length === 44){
                        // Preenche o formulário de código e envia
                        input.value = codigo;
                        let hidden = form.querySelector('input[name="submit_codigo"]');
                        if (!hidden) {
                          hidden = document.createElement('input');
                          hidden.type = 'hidden';
                          hidden.name = 'submit_codigo';
                          hidden.value = '1';
                          form.appendChild(hidden);
                        }
                        showOverlay();
                        form.submit();
                        return;
                      }
                    }
                  } catch(e) { /* ignora e deixa backend tentar OCR/QR */ }
                };
                img.onerror = function(){ /* sem preview, segue fluxo padrão */ };
                img.src = ev.target.result;
              } catch(e){ /* fallback para servidor */ }
            };
            reader.readAsDataURL(file);
          } catch(e) { /* navegador sem FileReader: segue fluxo padrão */ }
        });
      }
    })();

    // Foco e destaque automático no erro, se existir
    (function(){
      const err = document.getElementById('alertErroCupom');
      if (err) {
        try {
          err.scrollIntoView({ behavior: 'smooth', block: 'center' });
          err.focus({ preventScroll: true });
        } catch(e) {}
        // associa aos formulários para leitura por leitores de tela
        const forms = document.querySelectorAll('.register-form');
        forms.forEach(f => {
          const prev = f.getAttribute('aria-describedby');
          const add = 'alertErroCupom';
          f.setAttribute('aria-describedby', prev ? (prev + ' ' + add) : add);
        });
      }
    })();
  </script>
</body>
</html>

