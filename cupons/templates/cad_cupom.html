{% extends "base.html" %}
{% load static %}

{% block title %}Cadastrar Cupom{% endblock %}

{% block content %}
  {% include 'includes/header_3.html' %}

<div class="container mt-4">
  <h2 class="mb-3">Cadastro de Cupom</h2>

  <!-- FORMULÁRIO DE ENVIO DE IMAGEM -->
  <form action="{% url 'cad_cupom' id_participante %}" method="POST" enctype="multipart/form-data" id="form-cupom-img">
    {% csrf_token %}
    <div class="mb-3">
      <label for="img_cupom" class="form-label">Envie a imagem do seu cupom</label>
      <input type="file" class="form-control" name="img_cupom" id="img_cupom" accept="image/*" required>
    </div>
    <button type="submit" class="btn btn-primary">Enviar imagem</button>
  </form>

  <hr class="my-4">

  <!-- LEITURA COM A CÂMERA -->
  <h4>Ou escaneie o QR Code com a câmera</h4>
  
  <button id="btn-toggle-camera" class="btn btn-success mb-3" onclick="toggleCamera()">Ativar câmera</button>
  <button id="switch-camera" class="btn btn-secondary mb-3 ms-2" onclick="trocarCamera()" style="display:none;">Trocar câmera</button>

  <div id="reader" style="width: 300px; display: none;"></div>
  <p id="qr-result" class="mt-2 text-success fw-bold"></p>

  {% if msg %}
    <div class="alert alert-success mt-3">{{ msg }}</div>
  {% endif %}

  {% if qr_msg %}
    <div class="alert alert-info mt-2">{{ qr_msg }}</div>
  {% endif %}


</div>

<!-- ENVIAR CUPOM VIA FORMULÁRIO  -->
   <div style="margin-top: 2%; margin-bottom: 2%;">
    <hr>
      <h4>Ou envie o código do seu cupom</h4>

      <form action="{% url 'cad_cupom_codigo' id_participante %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <input type="text" class="form-control" id="cod_cupom" placeholder="Informe o código do seu cupom" name="cod_cupom">
          </imput>
        </div>

         <button type="submit" class="btn btn-dark">Enviar Cupom</button>

      </form>

   </div>






<!-- SCRIPTS -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const resultText = document.getElementById('qr-result');
  const readerDiv = document.getElementById('reader');
  const btnToggle = document.getElementById('btn-toggle-camera');
  const switchCameraBtn = document.getElementById('switch-camera');
  
  let html5QrCode;
  let cameraAtiva = false;
  let cameras = [];
  let currentCameraIndex = 0;

  function onScanSuccess(decodedText, decodedResult) {
    resultText.textContent = "QR Code detectado: " + decodedText;

    fetch("{% url 'salvar_qrcode_ajax' id_participante %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ dados_qr: decodedText })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        resultText.textContent += " ✅ (salvo com sucesso)";
      } else {
        resultText.textContent += " ❌ Erro: " + data.mensagem;
      }
    });

    pararCamera();
  }

  function toggleCamera() {
    if (!cameraAtiva) {
      iniciarCamera();
    } else {
      pararCamera();
    }
  }

  function iniciarCamera() {
    readerDiv.style.display = "block";
    html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        cameras = devices;
        const cameraId = cameras[currentCameraIndex].id;

        html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          onScanSuccess
        ).then(() => {
          cameraAtiva = true;
          btnToggle.textContent = "Parar câmera";
          btnToggle.classList.remove("btn-success");
          btnToggle.classList.add("btn-danger");
          switchCameraBtn.style.display = "inline-block";
        });
      }
    }).catch(err => {
      resultText.textContent = "Erro ao acessar câmera: " + err;
    });
  }

  function pararCamera() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        try {
          // Verifica se o scanner ainda tem o elemento interno
          if (html5QrCode._element) {
            html5QrCode.clear();
          }
        } catch (e) {
          console.warn("Erro ao limpar QRCode scanner:", e);
        }
        readerDiv.style.display = "none";
        cameraAtiva = false;
        btnToggle.textContent = "Ativar câmera";
        btnToggle.classList.remove("btn-danger");
        btnToggle.classList.add("btn-success");
        switchCameraBtn.style.display = "none";
      }).catch(err => {
        resultText.textContent = "Erro ao parar câmera: " + err;
      });
    }
  }

  function trocarCamera() {
    if (!cameras.length) return;
    pararCamera();
    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
    setTimeout(() => iniciarCamera(), 500);
  }
</script>

{% endblock %}
