{% extends "base_2.html" %}
{% load static %}

{% block title %}Cadastrar Cupom{% endblock %}

{% block content %}
  {% include 'includes/header_3.html' %}

<div class="container mt-4 mb-5">
  <h2 class="mb-3">Cadastro de Cupom</h2>

  {% if msg_sucesso %}
    <div class="alert alert-success">{{ msg_sucesso }}</div>
  {% endif %}
  {% if msg_erro %}
    <div class="alert alert-danger">{{ msg_erro }}</div>
  {% endif %}

  <!-- 1. Envio de imagem -->
  <form action="{% url 'cadastrar_cupom' id_participante %}" method="POST" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label fw-bold">1. Envie a imagem do seu cupom</label>
      <input type="file" class="form-control" name="img_cupom" accept="image/png, image/jpeg, image/jpg">
    </div>
    <button type="submit" name="submit_imagem" class="btn btn-primary">Enviar Imagem</button>
  </form>

  <hr class="my-4">

  <!-- 2. QR Code -->
  <div class="mb-4">
    <h4 class="fw-bold">2. Ou escaneie o QR Code com a câmera</h4>
    <button id="btn-toggle-camera" class="btn btn-success mb-3" onclick="toggleCamera()">Ativar Câmera</button>
    <button id="switch-camera" class="btn btn-secondary mb-3 ms-2" onclick="trocarCamera()" style="display:none;">Trocar Câmera</button>
    <div id="reader" style="width: 300px; border: 2px solid #eee; display: none;"></div>
    <p id="qr-result" class="mt-2 fw-bold"></p>
  </div>

  <hr class="my-4">

  <!-- 3. Código manual -->
  <form action="{% url 'cadastrar_cupom' id_participante %}" method="POST">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label fw-bold">3. Ou envie o código do seu cupom</label>
      <input type="text" class="form-control" name="cod_cupom" placeholder="Informe os 44 dígitos" maxlength="44" minlength="44" pattern="\d{44}">
    </div>
    <button type="submit" name="submit_codigo" class="btn btn-dark">Enviar Código</button>
  </form>
</div>

<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const resultText = document.getElementById('qr-result');
    const readerDiv = document.getElementById('reader');
    const btnToggle = document.getElementById('btn-toggle-camera');
    const switchCameraBtn = document.getElementById('switch-camera');
    let html5QrCode, cameraAtiva = false, cameras = [], currentCameraIndex = 0;

    function onScanSuccess(decodedText) {
      resultText.textContent = "QR Code detectado. Validando...";
      pararCamera();

      fetch("{% url 'salvar_qrcode_ajax' id_participante %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ dados_qr: decodedText })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Resposta AJAX:", data);
        if (data.status === 'ok') {
          resultText.textContent = "✅ " + data.mensagem;
          resultText.className = "mt-2 fw-bold text-success";
        } else {
          resultText.textContent = "❌ " + data.mensagem;
          resultText.className = "mt-2 fw-bold text-danger";
        }
      })
      .catch(err => {
        console.error("Erro AJAX:", err);
        resultText.textContent = "❌ Erro ao comunicar com o servidor.";
        resultText.className = "mt-2 fw-bold text-danger";
      });
    }

    window.toggleCamera = function() {
      if (!cameraAtiva) {
        iniciarCamera();
      } else {
        pararCamera();
      }
    }

    function iniciarCamera() {
      readerDiv.style.display = "block";
      html5QrCode = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          cameras = devices;
          const cameraId = cameras[currentCameraIndex].id;

          html5QrCode.start(cameraId, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess)
            .then(() => {
              cameraAtiva = true;
              btnToggle.textContent = "Parar Câmera";
              btnToggle.classList.replace("btn-success", "btn-danger");
              switchCameraBtn.style.display = "inline-block";
            });
        }
      }).catch(err => {
        resultText.textContent = "Erro ao acessar a câmera.";
        resultText.className = "mt-2 fw-bold text-danger";
      });
    }

    function pararCamera() {
      if (html5QrCode && cameraAtiva) {
        html5QrCode.stop().then(() => {
          cameraAtiva = false;
          readerDiv.style.display = "none";
          btnToggle.textContent = "Ativar Câmera";
          btnToggle.classList.replace("btn-danger", "btn-success");
          switchCameraBtn.style.display = "none";
        }).catch(err => console.warn("Erro ao parar a câmera:", err));
      }
    }

    window.trocarCamera = function() {
      if (cameras.length < 2) return;
      currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
      pararCamera();
      setTimeout(iniciarCamera, 250);
    }
  });
</script>
{% endblock %}
